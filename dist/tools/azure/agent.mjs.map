{"version":3,"file":"agent.mjs","sources":["../../../src/agents/azure/command.ts","../../../src/agents/azure/build-agent.ts"],"sourcesContent":["import * as os from 'node:os'\nimport * as process from 'node:process'\n\nconst CMD_PREFIX = '##vso['\n\nexport type CommandProperties = Record<string, string | object>\n\nexport enum TaskResult {\n    Succeeded = 0,\n    SucceededWithIssues = 1,\n    Failed = 2,\n    Cancelled = 3,\n    Skipped = 4\n}\n\n/**\n *  Command Format:\n *    ##vso[artifact.command key=value;key=value]user message\n *\n *  Examples:\n *    ##vso[task.progress value=58]\n *    ##vso[task.issue type=warning;]This is the user warning message\n **/\nexport function issueCommand(command: string, properties: CommandProperties, message: string): void {\n    const cmd = new Command(command, properties, message)\n    process.stdout.write(`${cmd.toString()}${os.EOL}`)\n}\n\nclass Command {\n    private readonly command: string\n    private readonly message: string\n    private readonly properties: CommandProperties\n\n    constructor(command: string, properties: CommandProperties, message: string) {\n        if (!command) {\n            command = 'missing.command'\n        }\n\n        this.command = command\n        this.properties = properties\n        this.message = message\n    }\n\n    toString(): string {\n        let cmdStr = CMD_PREFIX + this.command\n\n        if (this.properties && Object.keys(this.properties).length > 0) {\n            cmdStr += ' '\n            for (const key in this.properties) {\n                if (Object.prototype.hasOwnProperty.call(this.properties, key)) {\n                    const val = this.properties[key] as string\n                    if (val) {\n                        // safely append the val - avoid blowing up when attempting to\n                        // call .replace() if message is not a string for some reason\n                        cmdStr += `${key}=${escapeProperty(`${val || ''}`)};`\n                    }\n                }\n            }\n        }\n\n        cmdStr += ']'\n\n        // safely append the message - avoid blowing up when attempting to\n        // call .replace() if message is not a string for some reason\n        const message = `${this.message || ''}`\n        cmdStr += escapeData(message)\n\n        return cmdStr\n    }\n}\n\nfunction escapeData(s: string | object): string {\n    return toCommandValue(s).replace(/%/g, '%AZP25').replace(/\\r/g, '%0D').replace(/\\n/g, '%0A')\n}\n\nfunction escapeProperty(s: string | object): string {\n    return toCommandValue(s).replace(/%/g, '%AZP25').replace(/\\r/g, '%0D').replace(/\\n/g, '%0A').replace(/]/g, '%5D').replace(/;/g, '%3B')\n}\n\nfunction toCommandValue(input: string | object): string {\n    if (input === null || input === undefined) {\n        return ''\n    } else if (typeof input === 'string' || input instanceof String) {\n        return input as string\n    }\n    return JSON.stringify(input)\n}\n","import * as os from 'node:os'\nimport * as process from 'node:process'\nimport { BuildAgentBase, type IBuildAgent } from '@agents/common'\nimport { issueCommand, TaskResult } from './command'\n\nexport class BuildAgent extends BuildAgentBase implements IBuildAgent {\n    agentName = 'Azure Pipelines'\n\n    sourceDirVariable = 'BUILD_SOURCESDIRECTORY'\n    tempDirVariable = 'AGENT_TEMPDIRECTORY'\n    cacheDirVariable = 'AGENT_TOOLSDIRECTORY'\n\n    addPath(inputPath: string): void {\n        super.addPath(inputPath)\n        issueCommand('task.prependpath', {}, inputPath)\n    }\n\n    info = (message: string): void => {\n        process.stdout.write(`${message}${os.EOL}`)\n    }\n\n    debug = (message: string): void => issueCommand('task.debug', {}, message)\n\n    warn = (message: string): void => issueCommand('task.issue', { type: 'warning' }, message)\n\n    error = (message: string): void => issueCommand('task.issue', { type: 'error' }, message)\n\n    setSucceeded = (message: string, done?: boolean): void => this._setResult(TaskResult.Succeeded, message, done)\n\n    setFailed = (message: string, done?: boolean): void => this._setResult(TaskResult.Failed, message, done)\n\n    setOutput = (name: string, value: string): void => this._setVariable(name, value, true)\n\n    setVariable = (name: string, value: string): void => this._setVariable(name, value)\n\n    updateBuildNumber = (version: string): void => this._updateBuildNumber(version)\n\n    private _updateBuildNumber(version: string): void {\n        this.debug(`build number: ${version}`)\n        issueCommand('build.updatebuildnumber', {}, version)\n    }\n\n    private _setResult(result: TaskResult, message: string, done?: boolean): void {\n        this.debug(`task result: ${TaskResult[result]}`)\n        // add an error issue\n        if (result === TaskResult.Failed && message) {\n            this.error(message)\n        } else if (result === TaskResult.SucceededWithIssues && message) {\n            this.warn(message)\n        } else {\n            this.info(message)\n        }\n        // task.complete\n        const properties: Record<string, string> = { result: TaskResult[result] }\n        if (done) {\n            properties['done'] = 'true'\n        }\n        issueCommand('task.complete', properties, message)\n    }\n\n    private _setVariable(name: string, val: string, isOutput = false): void {\n        const key: string = this._getVariableKey(name)\n        const varValue = val || ''\n        process.env[key] = varValue\n\n        issueCommand(\n            'task.setvariable',\n            {\n                variable: name || '',\n                isOutput: (isOutput || false).toString(),\n                issecret: 'false'\n            },\n            varValue\n        )\n    }\n\n    private _getVariableKey(name: string): string {\n        return name.replace(/\\./g, '_').replace(/ /g, '_').toUpperCase()\n    }\n}\n"],"names":["TaskResult"],"mappings":"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"}